# GitHub Actions ワークフロー

このディレクトリには、読書管理アプリのCI/CDパイプラインを定義するGitHub Actionsワークフローが含まれています。

## ワークフロー概要

### 1. CI ワークフロー (`ci.yml`)

**トリガー条件:**
- `main`, `develop` ブランチへのプッシュ
- `main`, `develop` ブランチへのプルリクエスト

**ジョブ構成:**

#### test ジョブ
- **実行環境**: Ubuntu Latest
- **Node.js バージョン**: 18.x, 20.x (マトリックス)
- **実行内容**:
  - リポジトリのチェックアウト
  - Node.js のセットアップ
  - 依存関係のインストール
  - ESLint実行
  - TypeScript型チェック
  - ユニット・統合テスト実行
  - コードカバレッジのCodecovへのアップロード

#### build ジョブ
- **依存関係**: test ジョブの成功
- **実行内容**:
  - アプリケーションのビルド検証

#### e2e ジョブ
- **依存関係**: test ジョブの成功
- **実行内容**:
  - Playwrightブラウザのインストール
  - アプリケーションのビルド
  - E2Eテストの実行（Playwrightが自動でサーバー起動）
  - テスト結果・レポートのアーティファクト保存

#### security ジョブ
- **実行条件**: プルリクエスト時のみ
- **実行内容**:
  - セキュリティ監査
  - 依存関係チェック

#### performance ジョブ
- **依存関係**: test ジョブの成功
- **実行条件**: プルリクエスト時のみ
- **実行内容**:
  - アプリケーションのビルド
  - Lighthouse CIによるパフォーマンス測定（自動でサーバー起動）

### 2. Deploy ワークフロー (`deploy.yml`)

**トリガー条件:**
- `main` ブランチへのプッシュ（ステージング）
- リリース公開時（プロダクション）

**ジョブ構成:**

#### deploy-staging ジョブ
- **実行条件**: main ブランチへのプッシュ
- **環境**: staging
- **実行内容**:
  - テスト実行
  - ビルド
  - Vercelステージング環境へのデプロイ

#### deploy-production ジョブ
- **実行条件**: リリース公開時
- **環境**: production
- **実行内容**:
  - フルテストスイート実行
  - ビルド
  - Vercelプロダクション環境へのデプロイ
  - デプロイステータスの更新

### 3. CodeQL ワークフロー (`codeql.yml`)

**トリガー条件:**
- `main`, `develop` ブランチへのプッシュ
- `main` ブランチへのプルリクエスト
- 毎週日曜日の定期実行

**実行内容:**
- GitHubのCodeQL分析
- セキュリティ・品質の両方の観点からコード分析
- 脆弱性の自動検出

### 4. Dependabot 設定 (`dependabot.yml`)

**更新スケジュール:**
- 毎週月曜日 09:00 UTC
- npm パッケージの依存関係更新
- GitHub Actions の依存関係更新

**設定詳細:**
- 同時オープンPR数: 最大5件
- 自動アサイン・レビュー設定
- 適切なラベル付け

## 必要なシークレット設定

### Vercel デプロイ用
```
VERCEL_TOKEN          # Vercelアクセストークン
VERCEL_ORG_ID         # Vercel組織ID
VERCEL_PROJECT_ID     # VercelプロジェクトID
```

### コードカバレッジ用
```
CODECOV_TOKEN         # Codecovアップロード用トークン
```

### Lighthouse CI用（オプション）
```
LHCI_GITHUB_APP_TOKEN # Lighthouse CI GitHub Appトークン
```

## パフォーマンス基準

### Lighthouse スコア閾値
- **パフォーマンス**: 80点以上（警告）
- **アクセシビリティ**: 90点以上（エラー）
- **ベストプラクティス**: 80点以上（警告）
- **SEO**: 80点以上（警告）
- **PWA**: 無効

### テストカバレッジ基準
- **ユニットテスト**: 80%以上
- **統合テスト**: 主要機能100%
- **E2Eテスト**: クリティカルパス100%

## トラブルシューティング

### よくある問題

1. **E2Eテストの失敗**
   - Playwright レポートをアーティファクトからダウンロード
   - ブラウザの互換性問題を確認

2. **ビルドエラー**
   - TypeScript型エラーの確認
   - 依存関係の不整合をチェック

3. **デプロイ失敗**
   - Vercelシークレット設定の確認
   - ビルド成果物の確認

### ログとアーティファクト

- テスト結果: `playwright-results` アーティファクト
- テストレポート: `playwright-report` アーティファクト（失敗時）
- ビルド成果物: `build-files` アーティファクト
- コードカバレッジ: Codecov ダッシュボード

## メンテナンス

### 定期的な確認事項
- 依存関係の更新（Dependabot PR）
- セキュリティアラートの対応
- パフォーマンス指標の監視
- テスト実行時間の最適化

### ワークフロー更新時の注意点
- 本番環境への影響を最小限に
- テスト環境での事前検証
- ロールバック手順の準備